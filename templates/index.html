<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="An√°lisis Gaussiano de Emisiones de Gases Atmosf√©ricos">
    <meta name="theme-color" content="#667eea">
    <title>üåç Gaussian Emissions Analyzer</title>
    <!-- CSS Externo -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <!-- Scripts externos -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="banner">
        <div class="banner-content">
            <h1><i class="fas fa-wind icon-pulse"></i> Gaussian Emissions Analyzer</h1>
            <p style="font-style: italic;"><i class="fas fa-leaf"></i> Medir el suelo es anticipar impactos y fortalecer la sostenibilidad energ√©tica</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="main-container">
        <!-- Barra Lateral -->
        <div class="sidebar">
            <h3><i class="fas fa-upload"></i> Cargar Datos</h3>
            
            <form id="analysis-form">
                <!-- Secci√≥n 1: Tipo de Gas -->
                <div class="form-section">
                    <label for="gasType">
                        <i class="fas fa-flask"></i> Tipo de Gas
                    </label>
                    <select class="form-select" id="gas-type" name="gasType">
                        <option value="CH4" selected>üî• CH4 (Metano)</option>
                        <option value="CO2">üå´Ô∏è CO2 (Di√≥xido de Carbono)</option>
                        <option value="H2O">üíß H2O (Vapor de Agua)</option>
                    </select>
                </div>
                
                <!-- Secci√≥n 2: Archivo del Analizador -->
                <div class="form-section">
                    <label for="dataFile">
                        <i class="fas fa-file-alt"></i> Archivo Analizador (.data)
                    </label>
                    <input type="file" class="form-control" id="data-file" name="dataFile" accept=".data" required>
                    <small class="text-muted">LI-7810 Analyzer Data</small>
                </div>
                
                <!-- Secci√≥n 3: Archivo GPS -->
                <div class="form-section">
                    <label for="gpxFile">
                        <i class="fas fa-map-marked-alt"></i> Archivo GPS (.gpx)
                    </label>
                    <input type="file" class="form-control" id="gpx-file" name="gpxFile" accept=".gpx" required>
                    <small class="text-muted">GPS Track Data</small>
                </div>
                
                <!-- Bot√≥n de An√°lisis -->
                <button type="submit" class="btn-analyze">
                    <i class="fas fa-chart-line"></i> Analizar Datos
                </button>
            </form>
            
            <!-- Botones de Exportaci√≥n -->
            <div id="export-section" class="d-none">
                <h3><i class="fas fa-download"></i> Exportar Resultados</h3>
                
                <button id="export-csv-btn" class="btn-analyze" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
                    <i class="fas fa-file-csv"></i> Descargar CSV
                </button>
                
                <button id="export-pdf-btn" class="btn-analyze" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <i class="fas fa-file-pdf"></i> Descargar PDF
                </button>
            </div>
        </div>

        <!-- √Årea de Contenido -->
        <div class="content-area">
            <!-- Spinner de Carga -->
            <div id="loading-spinner" class="loading-spinner d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
                <h4 class="mt-3"><i class="fas fa-cog fa-spin"></i> Procesando datos...</h4>
                <p class="text-muted">Por favor espere mientras analizamos la informaci√≥n</p>
            </div>

            <!-- Resumen de Datos -->
            <div id="data-summary-card" class="result-card primary d-none fade-in-up">
                <h5>
                    <i class="fas fa-info-circle"></i> Resumen de Datos Procesados
                    <small style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                        Estad√≠sticas de las concentraciones medidas
                    </small>
                </h5>
                <div id="data-summary"></div>
            </div>

            <!-- Resultados del An√°lisis -->
            <div id="results-container" class="d-none">
                <div class="row">
                    <!-- Tasa de Emisi√≥n -->
                    <div class="col-md-6">
                        <div class="result-card success fade-in-up" style="animation-delay: 0.1s">
                            <h5>
                                <i class="fas fa-fire"></i> Tasa de Emisi√≥n (Q)
                                <small style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                                    Cantidad de gas emitido por unidad de tiempo
                                </small>
                            </h5>
                            <div id="q-value"></div>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas del Modelo -->
                    <div class="col-md-6">
                        <div class="result-card warning fade-in-up" style="animation-delay: 0.2s">
                            <h5>
                                <i class="fas fa-chart-bar"></i> Estad√≠sticas del Modelo Gaussiano
                                <small style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                                    Calidad del ajuste y par√°metros utilizados
                                </small>
                            </h5>
                            <div id="stats"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Metadatos del Modelo (Reproducibilidad) -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="result-card info fade-in-up" style="animation-delay: 0.25s">
                            <h5>
                                <i class="fas fa-info-circle"></i> Metadatos del Modelo (Reproducibilidad)
                                <small style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                                    Informaci√≥n t√©cnica para reproducir este an√°lisis
                                </small>
                            </h5>
                            <div id="metadata" style="font-size: 0.9rem; line-height: 1.8;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficas -->
            <div id="plots-container" class="d-none">
                <!-- Gr√°fico Observado vs Modelado -->
                <div id="obs-vs-pred-container" class="plot-container fade-in-up d-none" style="animation-delay: 0.3s">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-scatter"></i> Ajuste del Modelo: Observado vs Modelado
                        <small style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                            Comparaci√≥n entre concentraciones medidas y predichas por el modelo
                        </small>
                    </h5>
                    <div id="obs-vs-pred-plot"></div>
                </div>
                
                <!-- Mapa Interactivo -->
                <div class="plot-container fade-in-up" style="animation-delay: 0.4s">
                    <h5 class="mb-3">
                        <i class="fas fa-map-marked-alt"></i> Mapa Interactivo de Concentraciones
                        <small id="map-units" style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                            Distribuci√≥n espacial de concentraciones
                        </small>
                    </h5>
                    <div id="heatmap-plot"></div>
                </div>
                
                <!-- Serie Temporal y Rosa de Vientos -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="plot-container fade-in-up" style="animation-delay: 0.4s">
                            <h5 class="mb-3">
                                <i class="fas fa-clock"></i> Serie Temporal de Concentraciones
                                <small id="timeseries-units" style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                                    Variaci√≥n de concentraci√≥n en el tiempo
                                </small>
                            </h5>
                            <div id="timeseries-plot"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="plot-container fade-in-up" style="animation-delay: 0.5s">
                            <h5 class="mb-3">
                                <i class="fas fa-compass"></i> Rosa de Vientos
                                <small style="font-size: 0.8rem; font-weight: normal; color: #7f8c8d; display: block; margin-top: 5px;">
                                    Distribuci√≥n direccional de mediciones
                                </small>
                            </h5>
                            <div id="wind-rose"></div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTONES DE EXPORTACI√ìN AL FINAL -->
                <div id="export-buttons-simple" style="background: #d4edda; border: 3px solid #28a745; padding: 25px; margin-top: 30px; border-radius: 15px; display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                    <h3 style="color: #155724; margin: 0 0 15px 0; font-size: 1.5rem;">
                        <i class="fas fa-download"></i> Exportar Resultados del An√°lisis
                    </h3>
                    <p style="margin: 0 0 20px 0; color: #155724; font-size: 1.05rem;">
                        Descarga los resultados completos para incluirlos en tus informes:
                    </p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="window.location.href='/export/csv'" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 18px 35px; border: none; border-radius: 8px; font-size: 17px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: all 0.3s ease; flex: 1; min-width: 250px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'">
                            <i class="fas fa-file-csv"></i> DESCARGAR CSV
                            <div style="font-size: 0.85rem; font-weight: normal; margin-top: 5px;">Datos tabulares para an√°lisis</div>
                        </button>
                        <button onclick="window.location.href='/export/pdf'" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 18px 35px; border: none; border-radius: 8px; font-size: 17px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: all 0.3s ease; flex: 1; min-width: 250px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'">
                            <i class="fas fa-file-pdf"></i> DESCARGAR PDF
                            <div style="font-size: 0.85rem; font-weight: normal; margin-top: 5px;">Reporte completo con mapa satelital</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            $('#upload-form').on('submit', function(e) {
                e.preventDefault();
                
                var formData = new FormData();
                var dataFileInput = $('#dataFile')[0];
                var gpxFileInput = $('#gpxFile')[0];
                var gasType = $('#gasType').val();
                
                if (dataFileInput.files.length === 0 || gpxFileInput.files.length === 0) {
                    alert('Por favor seleccione ambos archivos (.data y .gpx)');
                    return;
                }
                
                formData.append('dataFile', dataFileInput.files[0]);
                formData.append('gpxFile', gpxFileInput.files[0]);
                formData.append('gasType', gasType);
                
                // Mostrar spinner
                $('#loading-spinner').removeClass('d-none');
                $('#results-container').addClass('d-none');
                $('#plots-container').addClass('d-none');
                
                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log('üöÄüöÄüöÄ INICIO DEL SUCCESS CALLBACK - VERSI√ìN NUEVA üöÄüöÄüöÄ');
                        console.log('Respuesta recibida:', response);
                        
                        // Ocultar spinner
                        $('#loading-spinner').addClass('d-none');
                        
                        if (response.error) {
                            alert('Error: ' + response.error);
                            if (response.trace) {
                                console.error('Trace:', response.trace);
                            }
                            return;
                        }
                        
                        // Mostrar resultados con animaci√≥n
                        console.log('‚úÖ Mostrando resultados y botones de exportaci√≥n...');
                        $('#data-summary-card').removeClass('d-none');
                        $('#results-container').removeClass('d-none');
                        $('#plots-container').removeClass('d-none');
                        
                        // Mostrar botones de exportaci√≥n (versi√≥n simple que S√ç funciona)
                        document.getElementById('export-buttons-simple').style.display = 'block';
                        console.log('‚úÖ Botones de exportaci√≥n ahora visibles');
                        
                        // Funci√≥n para formatear n√∫meros con m√°ximo 3 decimales
                        function formatNumber(num) {
                            if (num === null || num === undefined || isNaN(num)) return '0.000';
                            // Si el n√∫mero es muy grande o muy peque√±o, usar notaci√≥n cient√≠fica
                            if (Math.abs(num) >= 1e6 || (Math.abs(num) < 0.001 && num !== 0)) {
                                return num.toExponential(3);
                            }
                            // Para n√∫meros normales, usar 3 decimales
                            return num.toFixed(3);
                        }
                        
                        // Actualizar valores con dise√±o mejorado y unidades claras
                        var qHtml = `
                            <div class="stat-label">Tasa de Emisi√≥n (Q)</div>
                            <div class="stat-value" style="color: #27ae60;">
                                ${formatNumber(response.results.Q_hat_gps)} 
                                <span style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">g/s</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: -10px; margin-bottom: 15px;">
                                ¬± ${formatNumber(response.results.Q_std_gps)} g/s (desviaci√≥n est√°ndar)
                            </div>
                            <hr style="margin: 15px 0;">
                            <div class="stat-label">Tasa de Emisi√≥n (Q)</div>
                            <div class="stat-value" style="color: #27ae60;">
                                ${formatNumber(response.results.Q_hat_gph)} 
                                <span style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">g/h</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: -10px;">
                                ¬± ${formatNumber(response.results.Q_std_gph)} g/h (desviaci√≥n est√°ndar)
                            </div>
                        `;
                        
                        if (response.results.error) {
                            qHtml += `<div class="alert alert-warning mt-3 mb-0">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>No se pudo calcular:</strong><br>
                                ${response.results.error}
                            </div>`;
                            
                            // Mostrar informaci√≥n de debug si est√° disponible
                            if (response.results.debug_info) {
                                qHtml += `<div class="alert alert-info mt-2 mb-0">
                                    <small>
                                        <strong><i class="fas fa-info-circle"></i> Informaci√≥n de depuraci√≥n:</strong><br>
                                        ‚Ä¢ Puntos combinados: ${response.results.debug_info.merged_points}<br>
                                        ‚Ä¢ Puntos filtrados: ${response.results.debug_info.filtered_points}<br>
                                        ‚Ä¢ Concentraci√≥n background: ${response.results.debug_info.background.toFixed(2)}<br>
                                        ‚Ä¢ Rango de gas: ${response.results.debug_info.gas_range}
                                    </small>
                                </div>`;
                            }
                            
                            // Mostrar recomendaciones si est√°n disponibles
                            if (response.results.recommendations) {
                                var rec = response.results.recommendations;
                                qHtml += `
                                    <div class="alert alert-success mt-3 mb-0" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                                        <h6 class="mb-3"><i class="fas fa-lightbulb"></i> <strong>Recomendaciones para Mediciones Exitosas</strong></h6>
                                        
                                        <div class="mb-3">
                                            <strong><i class="fas fa-route"></i> En Campo (Durante la Medici√≥n):</strong>
                                            <ul class="mt-2 mb-0">
                                                ${rec.field_recommendations.map(r => `<li style="font-size: 0.9rem;">${r}</li>`).join('')}
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong><i class="fas fa-check-circle"></i> Calidad de Datos:</strong>
                                            <ul class="mt-2 mb-0">
                                                ${rec.data_quality.map(r => `<li style="font-size: 0.9rem;">${r}</li>`).join('')}
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-0">
                                            <strong><i class="fas fa-cloud-sun"></i> Condiciones √ìptimas:</strong>
                                            <ul class="mt-2 mb-0">
                                                ${rec.optimal_conditions.map(r => `<li style="font-size: 0.9rem;">${r}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        $('#q-value').html(qHtml);
                        
                        var statsHtml = `
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <div class="stat-label">Coeficiente R¬≤</div>
                                    <div class="stat-value" style="font-size: 1.5rem;">${response.results.R2.toFixed(3)}</div>
                                    <small style="color: #7f8c8d;">(ajuste del modelo)</small>
                                </div>
                                <div class="col-4">
                                    <div class="stat-label">Puntos Usados</div>
                                    <div class="stat-value" style="font-size: 1.5rem;">${response.results.n_points}</div>
                                    <small style="color: #7f8c8d;">(observaciones)</small>
                                </div>
                                <div class="col-4">
                                    <div class="stat-label">Clase Estabilidad</div>
                                    <div class="stat-value" style="font-size: 1.5rem;">${response.results.stability_used}</div>
                                    <small style="color: #7f8c8d;">(Pasquill-Gifford)</small>
                                </div>
                            </div>
                        `;
                        
                        // Agregar m√©tricas adicionales si est√°n disponibles
                        if (response.results.metrics) {
                            var m = response.results.metrics;
                            var units = response.data_summary.gas_units || 'ppm';
                            statsHtml += `
                                <hr style="margin: 15px 0;">
                                <h6 class="mb-2"><i class="fas fa-calculator"></i> M√©tricas de Ajuste Adicionales</h6>
                                <div class="row text-center">
                                    <div class="col-3">
                                        <div class="stat-label">MAE</div>
                                        <div style="font-size: 1.2rem; font-weight: 600; color: #3498db;">${m.MAE.toFixed(2)}</div>
                                        <small style="color: #7f8c8d; font-size: 0.75rem;">${units}<br>(Error Abs. Medio)</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="stat-label">RMSE</div>
                                        <div style="font-size: 1.2rem; font-weight: 600; color: #9b59b6;">${m.RMSE.toFixed(2)}</div>
                                        <small style="color: #7f8c8d; font-size: 0.75rem;">${units}<br>(Ra√≠z ECM)</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="stat-label">MSE</div>
                                        <div style="font-size: 1.2rem; font-weight: 600; color: #e67e22;">${m.MSE.toFixed(2)}</div>
                                        <small style="color: #7f8c8d; font-size: 0.75rem;">${units}¬≤<br>(Error Cuad. Medio)</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="stat-label">MAPE</div>
                                        <div style="font-size: 1.2rem; font-weight: 600; color: #16a085;">${m.MAPE.toFixed(2)}</div>
                                        <small style="color: #7f8c8d; font-size: 0.75rem;">%<br>(Error % Medio)</small>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Mostrar advertencia si R¬≤ es bajo
                        if (response.results.warning && response.results.suggestions) {
                            statsHtml += `
                                <div class="alert alert-warning mt-3 mb-0">
                                    <strong><i class="fas fa-exclamation-circle"></i> ${response.results.warning}</strong>
                                    <ul class="mt-2 mb-0">
                                        ${response.results.suggestions.map(s => `<li style="font-size: 0.9rem;">${s}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        } else if (response.results.R2 >= 0.7) {
                            statsHtml += `
                                <div class="alert alert-success mt-3 mb-0">
                                    <i class="fas fa-check-circle"></i> <strong>Excelente ajuste del modelo!</strong> 
                                    Los resultados son confiables.
                                </div>
                            `;
                        } else if (response.results.R2 >= 0.5) {
                            statsHtml += `
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fas fa-info-circle"></i> <strong>Buen ajuste del modelo.</strong> 
                                    Los resultados son aceptables pero pueden mejorarse.
                                </div>
                            `;
                        }
                        
                        $('#stats').html(statsHtml);
                        
                        // Actualizar metadatos del modelo (reproducibilidad)
                        if (response.metadata) {
                            var meta = response.metadata;
                            var metadataHtml = `
                                <div class="row">
                                    <div class="col-md-6">
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-code-branch" style="color: #3498db;"></i> 
                                            <strong>Versi√≥n del Modelo:</strong> ${meta.model_version}
                                        </p>
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-calculator" style="color: #9b59b6;"></i> 
                                            <strong>Modelo:</strong> ${meta.model_name}
                                        </p>
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-clock" style="color: #e67e22;"></i> 
                                            <strong>Hora de Procesamiento:</strong><br>
                                            <span style="font-size: 0.95rem;">${meta.processing_time} (${meta.timezone})</span>
                                        </p>
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-cloud" style="color: #16a085;"></i> 
                                            <strong>Clase de Estabilidad:</strong> ${meta.stability_class} (Pasquill-Gifford)
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-wind" style="color: #2ecc71;"></i> 
                                            <strong>Viento Estimado:</strong><br>
                                            <span style="font-size: 0.95rem;">
                                                Direcci√≥n: ${meta.wind_direction_deg.toFixed(1)}¬∞ | 
                                                Velocidad: ${meta.wind_speed_ms.toFixed(2)} m/s
                                            </span>
                                        </p>
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-map-pin" style="color: #e74c3c;"></i> 
                                            <strong>Fuente Estimada:</strong><br>
                                            <span style="font-size: 0.9rem;">
                                                Lat: ${meta.source_location.lat.toFixed(6)}¬∞, 
                                                Lon: ${meta.source_location.lon.toFixed(6)}¬∞
                                            </span>
                                        </p>
                                        <p style="margin-bottom: 10px;">
                                            <i class="fas fa-layer-group" style="color: #f39c12;"></i> 
                                            <strong>Concentraci√≥n Background:</strong> ${meta.background_concentration.toFixed(2)} ${response.data_summary.gas_units}
                                        </p>
                                        <p style="margin-bottom: 0;">
                                            <i class="fas fa-arrows-alt" style="color: #95a5a6;"></i> 
                                            <strong>Dispersi√≥n Espacial:</strong> ${meta.max_spatial_dispersion_km.toFixed(3)} km
                                        </p>
                                    </div>
                                </div>
                            `;
                            $('#metadata').html(metadataHtml);
                        }
                        
                        // Actualizar resumen de datos con dise√±o mejorado
                        if (response.data_summary) {
                            var units = response.data_summary.gas_units || 'ppm';
                            var gasIcon = response.data_summary.gas_type === 'CH4' ? 'üî•' : 
                                        response.data_summary.gas_type === 'CO2' ? 'üå´Ô∏è' : 'üíß';
                            
                            // Actualizar unidades en los t√≠tulos de gr√°ficos
                            $('#map-units').html(`Distribuci√≥n espacial de ${response.data_summary.gas_type} (${units})`);
                            $('#timeseries-units').html(`Variaci√≥n de ${response.data_summary.gas_type} en el tiempo (${units})`);
                            
                            $('#data-summary').html(`
                                <div class="row">
                                    <div class="col-md-6">
                                        <p style="margin-bottom: 12px;">
                                            <i class="fas fa-flask text-primary"></i> <strong>Gas Analizado:</strong> 
                                            ${gasIcon} <span style="font-size: 1.1rem; font-weight: 600;">${response.data_summary.gas_type}</span>
                                        </p>
                                        <p style="margin-bottom: 12px;">
                                            <i class="fas fa-chart-line text-success"></i> <strong>Concentraci√≥n Promedio:</strong><br>
                                            <span style="font-size: 1.3rem; font-weight: 600; color: #27ae60;">${response.data_summary.gas_mean.toFixed(2)}</span>
                                            <span style="font-size: 1.1rem; font-weight: 600; color: #2c3e50;"> ${units}</span>
                                        </p>
                                        <p style="margin-bottom: 12px;">
                                            <i class="fas fa-arrow-up text-danger"></i> <strong>Concentraci√≥n M√°xima:</strong><br>
                                            <span style="font-size: 1.2rem; font-weight: 600; color: #e74c3c;">${response.data_summary.gas_max.toFixed(2)}</span>
                                            <span style="font-size: 1rem; font-weight: 600; color: #2c3e50;"> ${units}</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p style="margin-bottom: 12px;">
                                            <i class="fas fa-arrow-down text-info"></i> <strong>Concentraci√≥n M√≠nima:</strong><br>
                                            <span style="font-size: 1.2rem; font-weight: 600; color: #3498db;">${response.data_summary.gas_min.toFixed(2)}</span>
                                            <span style="font-size: 1rem; font-weight: 600; color: #2c3e50;"> ${units}</span>
                                        </p>
                                        <p style="margin-bottom: 12px;">
                                            <i class="fas fa-map-marker-alt text-warning"></i> <strong>Total de Puntos GPS:</strong> 
                                            <span style="font-size: 1.2rem; font-weight: 600; color: #f39c12;">${response.data_summary.total_points}</span>
                                        </p>
                                        <p style="margin-bottom: 0;">
                                            <i class="fas fa-clock text-secondary"></i> <strong>Per√≠odo de Medici√≥n:</strong><br>
                                            <small style="font-size: 0.85rem; color: #7f8c8d;">${response.data_summary.time_range}</small>
                                        </p>
                                    </div>
                                </div>
                            `);
                        }
                        
                        // Crear gr√°ficas
                        try {
                            // Crear gr√°fico de observado vs modelado si est√° disponible
                            if (response.obs_vs_pred) {
                                console.log('Creando gr√°fico observado vs modelado...');
                                $('#obs-vs-pred-container').removeClass('d-none');
                                Plotly.newPlot('obs-vs-pred-plot', response.obs_vs_pred.data, response.obs_vs_pred.layout, {responsive: true});
                            }
                            
                            console.log('Creando mapa interactivo...');
                            
                            // Configuraci√≥n para el mapa interactivo con responsividad
                            var heatmapConfig = {
                                responsive: true,
                                displayModeBar: true,
                                modeBarButtonsToAdd: ['toggleHover'],
                                displaylogo: false,
                                scrollZoom: true
                            };
                            
                            // Ajustar altura seg√∫n el tama√±o de la pantalla
                            if (response.heatmap.layout) {
                                if (window.innerWidth < 768) {
                                    response.heatmap.layout.height = 400;
                                } else if (window.innerWidth < 992) {
                                    response.heatmap.layout.height = 500;
                                }
                            }
                            
                            Plotly.newPlot('heatmap-plot', response.heatmap.data, response.heatmap.layout, heatmapConfig);
                            
                            // Hacer que el mapa sea m√°s interactivo
                            var heatmapDiv = document.getElementById('heatmap-plot');
                            heatmapDiv.on('plotly_relayout', function(eventdata) {
                                console.log('Mapa actualizado:', eventdata);
                            });
                            
                            console.log('Creando rosa de vientos...');
                            
                            // Ajustar altura de rosa de vientos
                            if (response.wind_rose.layout) {
                                if (window.innerWidth < 768) {
                                    response.wind_rose.layout.height = 350;
                                }
                            }
                            
                            Plotly.newPlot('wind-rose', response.wind_rose.data, response.wind_rose.layout, {responsive: true});
                            
                            console.log('Creando serie temporal...');
                            
                            // Ajustar altura de serie temporal
                            if (response.timeseries.layout) {
                                if (window.innerWidth < 768) {
                                    response.timeseries.layout.height = 300;
                                }
                            }
                            
                            Plotly.newPlot('timeseries-plot', response.timeseries.data, response.timeseries.layout, {responsive: true});
                            
                            // Hacer que las gr√°ficas se redimensionen cuando cambie el tama√±o de ventana
                            window.addEventListener('resize', function() {
                                if (response.obs_vs_pred) {
                                    Plotly.Plots.resize('obs-vs-pred-plot');
                                }
                                Plotly.Plots.resize('heatmap-plot');
                                Plotly.Plots.resize('wind-rose');
                                Plotly.Plots.resize('timeseries-plot');
                            });
                            
                            console.log('‚úÖ Todas las gr√°ficas creadas exitosamente');
                        } catch(e) {
                            console.error('Error al crear gr√°ficas:', e);
                            alert('Error al crear las gr√°ficas: ' + e.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loading-spinner').addClass('d-none');
                        console.error('Error AJAX:', {xhr: xhr, status: status, error: error});
                        console.error('Respuesta:', xhr.responseText);
                        alert('Error en el servidor: ' + error + '\nEstado: ' + status);
                    }
                });
            });
            
            // Los botones ahora usan onclick directo en el HTML, m√°s simple y confiable
        });
    </script>
    
    <!-- JavaScript Modularizado -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
 
